<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Full Band Studio + Animals</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>

  <style>
    /* --- CSS STYLES --- */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 0;
      background-color: #2c3e50; 
      color: white;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }
    
    nav { 
        background-color: #1a252f; width: 100%; padding: 15px; 
        text-align: center; margin-bottom: 20px; 
        display: flex; justify-content: center; align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    nav a { color: #ecf0f1; text-decoration: none; margin: 0 15px; font-weight: bold; font-size: 1.1rem; }
    nav a:hover { color: #1abc9c; }

    .logout-btn {
        background: none; border: none; color: #ecf0f1;
        font-weight: bold; font-size: 1.1rem; cursor: pointer;
        margin: 0 15px; text-decoration: none;
    }

    .machine-wrapper {
      background: #34495e; padding: 25px; border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.4); margin-top: 10px;
      text-align: center; max-width: 1100px; width: 95%;
    }

    /* --- GRID STYLES --- */
    #grid-container {
      display: grid; gap: 4px; background: #222;
      padding: 12px; border-radius: 8px;
      overflow-x: auto; 
      margin-bottom: 20px;
      border: 1px solid #444;
      max-height: 65vh; 
      overflow-y: auto;
    }

    .row-label { 
      background: #16a085; color: white;
      display: flex; align-items: center; justify-content: center; 
      border-radius: 4px; font-size: 0.8rem;
      position: sticky; left: 0; z-index: 10;
      padding: 0 5px; min-width: 160px; 
      box-shadow: 2px 0 5px rgba(0,0,0,0.5);
    }

    /* COLOR CODING SECTIONS */
    .row-label.drums { background: #16a085; } /* Teal */
    .row-label.bass  { background: #8e44ad; } /* Purple */
    .row-label.piano { background: #27ae60; } /* Green */
    .row-label.fx    { background: #e67e22; } /* Orange */
    .row-label.animal{ background: #c0392b; } /* Red/Brown */

    .sound-select {
        background: rgba(0,0,0,0.2); color: #fff;
        border: none; border-radius: 3px;
        font-size: 0.8rem; width: 100%;
        padding: 6px; cursor: pointer; font-weight: bold;
    }
    option { background: #2c3e50; }

    .beat-box { 
        background: #95a5a6; height: 35px; min-width: 35px; 
        border-radius: 3px; cursor: pointer; 
        transition: all 0.1s;
    }
    .beat-box.normal { background-color: #3498db; }
    .beat-box.accent { background-color: #e74c3c; box-shadow: inset 0 0 0 3px #fff; }
    .beat-box:hover { opacity: 0.8; transform: scale(0.95); }

    .controls { 
        margin-top: 20px; padding: 20px; 
        background: #2c3e50; border-radius: 8px; 
        display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 15px;
    }
    
    button { padding: 10px 18px; cursor: pointer; border: none; border-radius: 6px; color: white; font-size: 0.9rem; font-weight: bold; transition: transform 0.1s;}
    button:active { transform: scale(0.95); }
    
    .btn-play { background-color: #27ae60; min-width: 100px; font-size: 1rem; }
    .btn-stop { background-color: #c0392b; }
    .btn-save { background-color: #2980b9; } 
    .btn-json { background-color: #8e44ad; } 
    .btn-audio { background-color: #d35400; }
    .btn-copy { background-color: #f39c12; color: #2c3e50; } 
    
    label { font-size: 0.9rem; color: #bdc3c7; font-weight: bold; }
    select, input { background: #ecf0f1; border: none; padding: 8px; border-radius: 4px; font-size: 0.9rem; color: #333; }
    .control-group { display: flex; align-items: center; gap: 5px; background: #222; padding: 5px 10px; border-radius: 5px; }
    .login-box { margin-top: 50px; padding: 20px; border-top: 1px solid #555; width: 100%; max-width: 400px; }
    .login-box button { width: 100%; background-color: #1abc9c; margin-top: 10px; }
  </style>
</head>
<body>

  <nav>
    <a href="/">Home</a>
    {% if user.is_authenticated %}
        <a href="{% url 'forum' %}">Forum</a>
        <form action="{% url 'logout' %}" method="post" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="logout-btn">Logout</button>
        </form>
    {% else %}
        <a href="{% url 'login_page' %}">Login</a>
    {% endif %}
  </nav>

  <h1>ðŸŽ¹ Full Band Studio</h1>

  <div class="machine-wrapper">
    <div class="controls">
        <div class="control-group">
            <label>BPM:</label>
            <input type="number" id="bpm-input" value="120" min="40" max="300" onchange="updateTempo()">
        </div>
        <div class="control-group">
            <label>Measures:</label>
            <select id="measures-select" onchange="buildGrid()">
                <option value="1m">1 Bar</option>
                <option value="2m" selected>2 Bars</option>
                <option value="4m">4 Bars</option>
                <option value="8m">8 Bars</option>
            </select>
        </div>
        <div class="control-group">
            <label>Subdivision:</label>
            <select id="speed-select" onchange="buildGrid()">
                <option value="4n">Quarter (1/4)</option>
                <option value="8n" selected>Eighth (1/8)</option>
                <option value="8t">Triplets (1/8T)</option>
                <option value="16n">Sixteenth (1/16)</option>
                <option value="32n">32nd (1/32)</option>
            </select>
        </div>

        <div class="control-group" style="border: 1px solid #f39c12;">
            <label style="color: #f39c12;">Copy:</label>
            <select id="copy-track-select" style="width: 100px;">
                <option value="all">All Tracks</option>
            </select>
            <label style="color: #f39c12;">|</label>
            <input type="number" id="copy-src" value="1" min="1" max="8" style="width: 35px;">
            <label style="color: #f39c12;">â†’</label>
            <input type="number" id="copy-dest" value="2" min="1" max="8" style="width: 35px;">
            <button class="btn-copy" onclick="copyMeasures()">Go</button>
        </div>
        
        <div style="width: 100%; height: 10px;"></div> 

        <button id="btn-play" class="btn-play" onclick="playBeats()">â–¶ Play</button>
        <button class="btn-stop" onclick="clearAll()">ðŸ—‘ Clear All</button>
        <button class="btn-save" onclick="saveToCloud()">ðŸ’¾ Save Cloud</button>
        <button class="btn-json" onclick="downloadJson()">â¬‡ JSON</button>
        <button class="btn-audio" onclick="exportAudio()">ðŸŽµ Export Audio</button>
    </div>

    <div id="grid-container"></div>
    {% csrf_token %}
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
  </div>

  <script>
    // --- 1. SETTINGS & STATE ---
    let songData = []; 
    // 20 Tracks Total
    const trackIds = [
        'track-0', 'track-1', 'track-2', 'track-3', // Drums
        'track-4', 'track-5', 'track-6', 'track-7', // Bass
        'track-8', 'track-9', 'track-10', 'track-11', // Piano
        'track-12', 'track-13', 'track-14', 'track-15', // Game FX
        'track-16', 'track-17', 'track-18', 'track-19'  // Animals (Now 4 rows)
    ];
    
    // UPDATED ASSIGNMENTS
    let trackAssignments = {
        'track-0': 'kick', 'track-1': 'snare', 'track-2': 'hihat', 'track-3': 'tom1',
        'track-4': 'bass-C2', 'track-5': 'bass-E2', 'track-6': 'bass-G2', 'track-7': 'bass-B2',
        'track-8': 'piano-C4', 'track-9': 'piano-E4', 'track-10': 'piano-G4', 'track-11': 'piano-B4',
        'track-12': 'fx-C5', 'track-13': 'fx-E5', 'track-14': 'fx-G5', 'track-15': 'fx-C6',
        
        // NEW: Specific Assignments for your 4 sounds
        'track-16': 'cat_meow', 
        'track-17': 'cow', 
        'track-18': 'cricket', 
        'track-19': 'horse'
    };

    const gridDiv = document.getElementById('grid-container');
    let isPlaying = false; 
    const recorder = new Tone.Recorder();

    // --- 2. AUDIO ENGINE ---
    
    // UPDATED: Added your specific WAV files
    // Ensure your files in /static/sounds/ are named exactly:
    // cat_meow.wav, cow.wav, cricket.wav, horse.wav
    const drumPlayers = new Tone.Players({
        // Standard Kit
        "kick": "https://tonejs.github.io/audio/drum-samples/CR78/kick.mp3",
        "snare": "https://tonejs.github.io/audio/drum-samples/CR78/snare.mp3",
        "hihat": "https://tonejs.github.io/audio/drum-samples/CR78/hihat.mp3",
        "clap": "https://tonejs.github.io/audio/drum-samples/CR78/tom1.mp3", 
        "tom1": "https://tonejs.github.io/audio/drum-samples/CR78/tom1.mp3", 
        "tom2": "https://tonejs.github.io/audio/drum-samples/CR78/tom2.mp3", 
        "tom3": "https://tonejs.github.io/audio/drum-samples/CR78/tom3.mp3", 
        "bongo": "https://tonejs.github.io/audio/drum-samples/CR78/bongo1.mp3",

        // BARNYARD KIT (Local .wav Files)
        "cat_meow": "/static/player/sounds/cat_meow.wav",
        "cow": "/static/player/sounds/cow.wav",
        "cricket": "/static/player/sounds/cricket.wav",
        "horse": "/static/player/sounds/horse.wav"
    }).toDestination();
    
    // PIANO
    const pianoSampler = new Tone.Sampler({
        urls: { "C4": "C4.mp3", "D#4": "Ds4.mp3", "F#4": "Fs4.mp3", "A4": "A4.mp3" },
        release: 1,
        baseUrl: "https://tonejs.github.io/audio/salamander/"
    }).toDestination();

    // BASS SYNTH
    const bassSynth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "sawtooth" },
        envelope: { attack: 0.01, decay: 0.1, sustain: 0.3, release: 1 }
    }).toDestination();
    bassSynth.volume.value = -5;

    // GAME FX
    const fxSynth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "square" }, 
        envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.5 }
    }).toDestination();
    fxSynth.volume.value = -8;

    drumPlayers.connect(recorder);
    pianoSampler.connect(recorder);
    bassSynth.connect(recorder);
    fxSynth.connect(recorder);

    const soundGroups = {
        "Drums (CR78)": ["kick", "snare", "hihat", "clap", "tom1", "tom2", "tom3", "bongo"],
        "Bass Synth": ["bass-C2", "bass-D2", "bass-E2", "bass-G2", "bass-A2", "bass-B2"],
        "Piano": ["piano-C4", "piano-D4", "piano-E4", "piano-G4", "piano-A4", "piano-B4", "piano-C5"],
        "8-Bit FX": ["fx-C5", "fx-E5", "fx-G5", "fx-C6", "fx-E6"],
        "Barnyard (Local)": ["cat_meow", "cow", "cricket", "horse"] // Updated Group
    };

    // --- 3. GRID BUILDER ---
    function buildGrid() {
        gridDiv.innerHTML = ''; 
        
        const copySelect = document.getElementById('copy-track-select');
        copySelect.innerHTML = '<option value="all">All Tracks</option>';
        
        trackIds.forEach((trackId, index) => {
            const currentSound = trackAssignments[trackId];
            let name = currentSound
                .replace('piano-', 'Pno ')
                .replace('bass-', 'Bass ')
                .replace('fx-', '8-Bit ')
                .replace('tom', 'Tom ')
                .replace('cat_meow', 'Cat')
                .replace('_', ' ');
            name = name.charAt(0).toUpperCase() + name.slice(1);
            
            const opt = document.createElement('option');
            opt.value = trackId;
            opt.innerText = `Row ${index + 1}: ${name}`;
            copySelect.appendChild(opt);
        });

        const speed = document.getElementById('speed-select').value;      
        const measures = document.getElementById('measures-select').value; 
        const totalDuration = Tone.Time(measures).toSeconds();
        const stepDuration = Tone.Time(speed).toSeconds();
        const totalCols = Math.round(totalDuration / stepDuration);
        
        gridDiv.style.gridTemplateColumns = `160px repeat(${totalCols}, 1fr)`; 
        const stepsPerMeasure = Math.round(Tone.Time("1m").toSeconds() / stepDuration);

        trackIds.forEach((trackId) => {
            const label = document.createElement('div');
            
            // Logic to color the new rows
            const soundName = trackAssignments[trackId];
            if (soundName.startsWith('piano')) label.className = 'row-label piano';
            else if (soundName.startsWith('bass')) label.className = 'row-label bass';
            else if (soundName.startsWith('fx')) label.className = 'row-label fx';
            else if (soundGroups["Barnyard (Local)"].includes(soundName)) label.className = 'row-label animal';
            else label.className = 'row-label drums';

            const select = document.createElement('select');
            select.className = 'sound-select';
            
            for (const [groupName, sounds] of Object.entries(soundGroups)) {
                const group = document.createElement('optgroup');
                group.label = groupName;
                sounds.forEach(sound => {
                    const opt = document.createElement('option');
                    opt.value = sound;
                    let displayName = sound
                        .replace('piano-', 'Pno ')
                        .replace('bass-', 'Bass ')
                        .replace('fx-', '8-Bit ')
                        .replace('tom', 'Tom ')
                        .replace('bongo', 'Bongo')
                        .replace('cat_meow', 'Cat Meow')
                        .replace('_', ' ');
                    displayName = displayName.charAt(0).toUpperCase() + displayName.slice(1);
                    opt.innerText = displayName;
                    if(trackAssignments[trackId] === sound) opt.selected = true;
                    group.appendChild(opt);
                });
                select.appendChild(group);
            }

            select.onchange = (e) => {
                trackAssignments[trackId] = e.target.value;
                playPreview(e.target.value); 
                buildGrid(); 
            };
            label.appendChild(select);
            gridDiv.appendChild(label);

            for (let i = 0; i < totalCols; i++) {
                const box = document.createElement('div');
                box.className = 'beat-box';
                box.dataset.track = trackId; 
                if (i > 0 && i % stepsPerMeasure === 0) { box.style.borderLeft = "2px solid #666"; }
                else if (i > 0 && i % (stepsPerMeasure/4) === 0) { box.style.borderLeft = "1px solid #444"; }
                
                const time = i * stepDuration;
                box.dataset.time = time.toFixed(4);
                const existingNote = songData.find(note => note.track === trackId && Math.abs(note.time - time) < 0.001);
                
                if (existingNote) {
                    if (existingNote.velocity > 0.8) { box.classList.add('accent'); } 
                    else { box.classList.add('normal'); }
                }
                box.onclick = function() { toggleBox(this); };
                gridDiv.appendChild(box);
            }
        });
    }

    // --- 4. COPY FUNCTION ---
    function copyMeasures() {
        const srcBar = parseInt(document.getElementById('copy-src').value);
        const destBar = parseInt(document.getElementById('copy-dest').value);
        const selectedTrack = document.getElementById('copy-track-select').value;

        if(srcBar === destBar) return alert("Source and Destination cannot be the same!");
        
        const barDuration = Tone.Time("1m").toSeconds();
        const startTime = (srcBar - 1) * barDuration;
        const endTime = srcBar * barDuration;
        const timeOffset = (destBar - srcBar) * barDuration;
        
        const notesToCopy = songData.filter(n => {
            const inTimeWindow = n.time >= startTime - 0.001 && n.time < endTime - 0.001;
            const correctTrack = (selectedTrack === 'all') || (n.track === selectedTrack);
            return inTimeWindow && correctTrack;
        });
        
        if(notesToCopy.length === 0) return alert(`No notes found in Bar ${srcBar}.`);
        
        notesToCopy.forEach(note => {
            const newTime = note.time + timeOffset;
            const exists = songData.find(n => n.track === note.track && Math.abs(n.time - newTime) < 0.001);
            if(!exists) {
                songData.push({
                    track: note.track,
                    time: newTime,
                    velocity: note.velocity
                });
            }
        });
        buildGrid(); 
    }

    // --- 5. LOGIC & PLAYBACK ---
    function playPreview(soundName) {
        if (soundName.startsWith('piano-')) {
             const note = soundName.replace('piano-', '');
             pianoSampler.triggerAttackRelease(note, "8n");
        } else if (soundName.startsWith('bass-')) {
             const note = soundName.replace('bass-', '');
             bassSynth.triggerAttackRelease(note, "8n");
        } else if (soundName.startsWith('fx-')) {
             const note = soundName.replace('fx-', '');
             fxSynth.triggerAttackRelease(note, "16n");
        } else {
             if (drumPlayers.loaded && drumPlayers.has(soundName)) {
                 drumPlayers.player(soundName).start();
             }
        }
    }

    function toggleBox(box) {
        const trackId = box.dataset.track;
        const time = parseFloat(box.dataset.time);
        const noteIndex = songData.findIndex(n => n.track === trackId && Math.abs(n.time - time) < 0.001);
        const existingNote = songData[noteIndex];
        const currentSound = trackAssignments[trackId];

        if (!existingNote) {
            songData.push({ track: trackId, time: time, velocity: 0.6 });
            box.className = 'beat-box normal';
            playPreview(currentSound); 
        } else if (existingNote.velocity < 0.8) {
            existingNote.velocity = 1.0;
            box.className = 'beat-box accent';
            playPreview(currentSound); 
        } else {
            songData.splice(noteIndex, 1);
            box.className = 'beat-box'; 
        }
        if(isPlaying) playBeats(); 
    }

    async function playBeats() {
        await Tone.start();
        if (!drumPlayers.loaded) await Tone.loaded();
        
        const btn = document.getElementById('btn-play');
        const measures = document.getElementById('measures-select').value;
        const speed = document.getElementById('speed-select').value;
        
        if (isPlaying) {
            Tone.Transport.stop();
            isPlaying = false;
            btn.innerText = "â–¶ Play";
            btn.style.backgroundColor = "#27ae60"; 
        } else {
            updateTempo(); 
            Tone.Transport.cancel(); 

            songData.forEach(note => {
                Tone.Transport.schedule((time) => {
                    const soundName = trackAssignments[note.track]; 
                    const velocity = (note.velocity > 0.8) ? 1 : 0.7; 

                    if (soundName.startsWith('piano-')) {
                        const noteName = soundName.replace('piano-', '');
                        pianoSampler.triggerAttackRelease(noteName, speed, time, velocity);
                    } else if (soundName.startsWith('bass-')) {
                        const noteName = soundName.replace('bass-', '');
                        bassSynth.triggerAttackRelease(noteName, speed, time, velocity);
                    } else if (soundName.startsWith('fx-')) {
                        const noteName = soundName.replace('fx-', '');
                        fxSynth.triggerAttackRelease(noteName, "16n", time, velocity);
                    } else {
                        if(drumPlayers.has(soundName)){
                            const player = drumPlayers.player(soundName);
                            player.volume.value = (note.velocity > 0.8) ? 0 : -6;
                            player.start(time);
                        }
                    }
                }, note.time);
            });

            Tone.Transport.loop = true;
            Tone.Transport.loopEnd = measures; 
            Tone.Transport.start();
            isPlaying = true;
            btn.innerText = "â¸ Pause";
            btn.style.backgroundColor = "#c0392b"; 
        }
    }

    function clearAll() { 
        if(isPlaying) playBeats(); 
        songData = []; 
        buildGrid(); 
    }

    function saveToCloud() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const payload = { title: "My Composition", notes: songData, settings: trackAssignments };

        fetch('/save-composition/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') alert('Saved! ID: ' + data.id);
            else alert('Error: ' + data.message);
        })
        .catch(err => alert("Error connecting to server."));
    }

    function downloadJson() {
        const saveData = { tracks: trackAssignments, notes: songData };
        const text = JSON.stringify(saveData, null, 2);
        const blob = new Blob([text], { type: "application/json" });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "beat.json";
        link.click();
    }

    async function exportAudio() {
        if (songData.length === 0) return alert("Make a beat first!");
        if(isPlaying) playBeats(); 
        
        alert("Recording... please wait until the loop finishes.");
        await Tone.start();
        if (!drumPlayers.loaded) await Tone.loaded();
        
        updateTempo();
        const recorder = new Tone.Recorder({ mimeType: "audio/webm" });
        
        drumPlayers.connect(recorder);
        pianoSampler.connect(recorder);
        bassSynth.connect(recorder);
        fxSynth.connect(recorder);
        
        recorder.start();
        
        const measures = document.getElementById('measures-select').value;
        const speed = document.getElementById('speed-select').value;
        const totalDuration = Tone.Time(measures).toSeconds();
        const now = Tone.now(); 
        
        songData.forEach(note => {
             const time = now + note.time;
             const soundName = trackAssignments[note.track]; 
             const velocity = (note.velocity > 0.8) ? 1 : 0.7;

             if (soundName.startsWith('piano-')) {
                 pianoSampler.triggerAttackRelease(soundName.replace('piano-', ''), speed, time, velocity);
             } else if (soundName.startsWith('bass-')) {
                 bassSynth.triggerAttackRelease(soundName.replace('bass-', ''), speed, time, velocity);
             } else if (soundName.startsWith('fx-')) {
                 fxSynth.triggerAttackRelease(soundName.replace('fx-', ''), "16n", time, velocity);
             } else {
                 if(drumPlayers.has(soundName)){
                     const player = drumPlayers.player(soundName);
                     player.volume.value = (note.velocity > 0.8) ? 0 : -6;
                     player.start(time);
                 }
             }
        });

        setTimeout(async () => {
            const recording = await recorder.stop();
            const url = URL.createObjectURL(recording);
            const anchor = document.createElement("a");
            anchor.download = "my_beat.webm";
            anchor.href = url;
            anchor.click();
            alert("Download ready!");
        }, (totalDuration + 0.5) * 1000); 
    }

    function updateTempo() {
        Tone.Transport.bpm.value = document.getElementById('bpm-input').value;
    }

    window.onload = function() { buildGrid(); updateTempo(); };
  </script>
</body>
</html>