{% extends 'base_generic.html' %}

{% block title %}Forum{% endblock %}

{% block content %}
  <h1 style="color: red;">Welcome To The Forums!</h1>

  {# Show Django’s success/error notifications #}
  {% if messages %}
    <ul class="alerts">
      {% for msg in messages %}
        <li class="{{ msg.tags }}">{{ msg }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  {# Loop through your Message objects as 'posts' #}
  {% if posts %}
    {% for message in posts %}
      <div class="message">
        <h2>{{ message.content }}</h2>
        <p>Posted by {{ message.user.username }} on {{ message.created_at }}</p>

        <h3>Replies:</h3>
        {% if message.replies.all %}
          {% for reply in message.replies.all %}
            <div class="reply" style="margin-left:20px; border-left:2px solid #ccc; padding-left:10px;">
              <strong>{{ reply.user.username }}</strong> – {{ reply.created_at }}
              <p>{{ reply.content }}</p>
            </div>
          {% endfor %}
        {% else %}
          <p>No replies yet.</p>
        {% endif %}

        <p>
          <a href="#reply-form"
             class="reply-link"
             data-msg-id="{{ message.id }}">
            Reply
          </a>
        </p>
      </div>
      <hr>
    {% endfor %}
  {% else %}
    <p>No messages yet. Be the first to post!</p>
  {% endif %}
{% endblock %}

{% block reply_form %}
  {% if user.is_authenticated %}
    <div id="reply-form">
      <h2>Reply to a Message</h2>
      <form method="post" action="{% url 'forum' %}">
        {% csrf_token %}
        {{ reply_form.as_p }}

        {# Hidden field for message ID, set by JS #}
        <input type="hidden" name="message_id" id="reply-message-id" required>

        <button type="submit">Reply</button>
      </form>
    </div>
  {% else %}
    <p><a href="{% url 'login' %}">Log in</a> to reply.</p>
  {% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('JavaScript loaded');  // Debugging line to confirm JS execution

    document.querySelectorAll('.reply-link').forEach(function(link) {
      console.log('Reply link found for message ID:', link.getAttribute('data-msg-id'));

      link.addEventListener('click', function(e) {
        e.preventDefault();  // Prevent default link behavior

        const msgId = this.getAttribute('data-msg-id');
        console.log('Clicked reply for message ID:', msgId);  // Debugging line

        if (msgId) {
          document.getElementById('reply-message-id').value = msgId;
          console.log('Hidden input set with message ID:', msgId);
          document.getElementById('reply-form').scrollIntoView({ behavior: 'smooth' });
        } else {
          console.log('No message ID found!');
        }
      });
    });
  });
</script>
{% endblock %}

